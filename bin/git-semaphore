#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

begin
  require 'git-semaphore'
rescue LoadError
  require 'rubygems'
  require 'git-semaphore'
end

options = Trollop::options do
  version Git::Semaphore::COPYRIGHT
  banner Git::Semaphore::BANNER
  opt :'working-dir', 'Print working dir', :short => 'w', :default => false
  opt :'check-auth', 'Check auth token', :short => 'a', :default => false
  opt :'check-project', 'Check project token', :short => 'p', :default => false
  opt :'git-config', 'Print git settings', :short => 'g', :default => false
  opt :'env-config', 'Print environment settings', :short => 'e', :default => false
end

repo = Grit::Repo.new(Dir.pwd) rescue nil
app = Git::Semaphore::App.new(repo, ENV)

if options[:'working-dir']
  puts Dir.pwd
  exit 0
end

if options[:'check-auth']
  unless app.auth_token
    STDERR.puts 'Please set - and export - the SEMAPHORE_AUTH_TOKEN env variable'
    STDERR.puts 'Alternatively, set semaphore.authtoken in your local git config'
    exit -1
  else
    exit 0
  end
end

if options[:'check-project']
  unless app.project_token
    STDERR.puts 'Please set - and export - the SEMAPHORE_PROJECT_TOKEN env variable'
    STDERR.puts 'Alternatively, set semaphore.projecttoken in your local git config'
    exit -1
  else
    exit 0
  end
end

if options[:'env-config']
  puts "export SEMAPHORE_AUTH_TOKEN=\"#{app.env_auth_token}\""
  puts "export SEMAPHORE_PROJECT_TOKEN=\"#{app.env_project_token}\""
  exit 0
end

if options[:'git-config']
  puts "git config --local --replace-all semaphore.authtoken \"#{app.git_auth_token}\""
  puts "git config --local --replace-all semaphore.projecttoken \"#{app.git_project_token}\""
  exit 0
end

fail "Coming soon!"

# That's all, Folks!
